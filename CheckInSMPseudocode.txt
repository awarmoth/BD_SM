module level variables: ResponseReady, ReportStatus, BadResponseCounter, CurrentState
CheckIn enum states: Reporting_1, WaitForResponse_1, Reporting_2
module functions: DuringReporting_1, DuringWaitForResponse_1, DuringReporting_2


//NEED TO ASK TAs ABOUT WHAT TO DO IF YOU GET AN ES_NO_EVENT OUT OF YOUR DURING FUNCTION
//RIGHT NOW THIS IS CODED AS SPECIFIED IN THE STATE CHART
//HOWEVER COMMENTS WERE ADDED AS POSSIBLE AMENDMENTS/CONCERNS FOR THE STATE CHART

void StartCheckInSM(ES_Event CurrentEvent)
{
	If CurrentEvent is not ES_ENTRY_HISTORY
		Set CurrentState to Reporting_1
	Endif
	
	Call RunCheckInSM with CurrentEvent as the event parameter
}
End StartCheckInSM



ES_Event RunCheckInSM(ES_Event CurrentEvent)
{
	local variable MakeTransition
	local variable NextState
	local variable EntryEvent
	local variable ReturnEvent
	
	Initialize MakeTransition to false
	Initialize NextState to CurrentState
	Initialize EntryEvent to ES_ENTRY by default
	Initialize ReturnEvent to CurrentEvent assuming no consuming of event
	
	If CurrentState is Reporting_1 //NOTE CORRECT STATE MACHINE TO NOT TURN ON TAPE CONTROL ON Reporting_1 EXIT
		
		Call DuringReporting_1 and set CurrentEvent to its return value
		
		If CurrentEvent is not an ES_NO_EVENT
		
			If CurrentEvent is ES_DriveAlongTape
			
				If ResponseReady is LastStation //module variables aren't set until exit runs
					Set MakeTransition to true				
					Set ReturnEvent to ES_ArrivedAtStation
				Endif
				
				If ResponseReady is not LastStation and ResponseReady is not supply depot //module variables aren't set until exit runs
					Set NextState to WaitForResponse_1
					Set MakeTransition to true
					Set ReturnEvent to ES_NO_EVENT
					Enable wire following control law
					Start driving
				Endif
				
				If ResponseReady is supply depot //module variables aren't set until exit runs
					Set NextState to Reporting_2
					Set MakeTransition to true
					Set ReturnEvent to ES_NO_EVENT
					Enable wire following control law
					Start driving
				Endif
			
			End ES_DriveAlongTape block
			
		Endif
		
	End Reporting_1 block
	
	If CurrentState is WaitForResponse_1
		
		Call DuringWaitForResponse_1 and set CurrentEvent to its return value
		
		If CurrentEvent is not an ES_NO_EVENT
		
			If CurrentEvent is ES_StationDetected
			
				If LastStation - Direction is ResponseReady
					Set MakeTransition to true	
					Stop driving
					Disable wire following control law
					Set ReturnEvent to ES_ArrivedAtStation
				Endif
				
				//DO THESE NEED TO BE ELSE IFs?
				If LastStation - Direction is not ResponseReady
					Set MakeTransition to true
					Set ReturnEvent to ES_NO_EVENT
				Endif
			
			End ES_StationDetected block
			
		Endif
		
	End WaitForResponse_1 block
	
	If CurrentState is Reporting_2
		
		Call DuringReporting_2 and set CurrentEvent to its return value
		
		If CurrentEvent is not an ES_NO_EVENT
		
			If CurrentEvent is ES_Front_Bump_Detected
				Set MakeTransition to true	
				Stop driving
				Disable wire following control law
				Set ReturnEvent to ES_ArrivedAtReload			
			End ES_Front_Bump_Detected block
			
		Endif
	
	End Reporting_2 block
	
	If MakeTransition is true
		
		Set CurrentEvent to ES_EXIT
		Call RunCheckInSM with CurrentEvent as the event parameter
					
		Set CurrentState to NextState
		Call RunCheckInSM with EntryEvent as the event parameter
			
	Endif
	
	Return ReturnEvent
}
End RunCheckInSM



ES_Event DuringReporting_1(ES_Event ThisEvent)
{
	local variable ReturnEvent
	
	Initialize ReturnEvent to ThisEvent assuming no re-mapping or consumption
	
	If ThisEvent is ES_ENTRY or ES_ENTRY_HISTORY
		Set ReturnEvent to ES_NO_EVENT
		//Probably want to initialize module variables here as well
	EndIf
	
	ElseIf ThisEvent is ES_EXIT
		//Probably want to switch these initializations to occur after ES_ENTRY
		Set ResponseReady to getResponseReady
		Set LastStation to getLastStation
		Set Direction from sign(LastStation - ResponseReady)
		Set ReturnEvent to ES_NO_EVENT
	EndIf
	
	ElseIf ThisEvent is not ES_DriveAlongTape
			Set ReturnEvent to ES_NO_EVENT
	Endif
	
	Return ReturnEvent
}
End DuringReporting_1



ES_Event DuringWaitForResponse_1(ES_Event ThisEvent)
{
	local variable ReturnEvent
	
	Initialize ReturnEvent to ThisEvent assuming no re-mapping or consumption
	
	If ThisEvent is ES_ENTRY or ES_ENTRY_HISTORY
		Set ReturnEvent to ES_NO_EVENT
	EndIf
	
	ElseIf ThisEvent is ES_EXIT
		Set LastStation to (LastStation - Direction)
		Set ReturnEvent to ES_NO_EVENT
	EndIf
	
	ElseIf ThisEvent is not ES_StationDetected
		Set ReturnEvent to ES_NO_EVENT
	EndIf
	
	Return ReturnEvent
}
End DuringWaitForResponse_1


ES_Event DuringReporting_2(ES_Event ThisEvent)
{
	local variable ReturnEvent
	
	Initialize ReturnEvent to ThisEvent assuming no re-mapping or consumption
	
	If ThisEvent is ES_ENTRY or ES_ENTRY_HISTORY
		Set ReturnEvent to ES_NO_EVENT
	EndIf
	
	ElseIf ThisEvent is ES_EXIT
		Set LastStation to supply depot
		Set ReturnEvent to ES_NO_EVENT
	EndIf
	
	ElseIf ThisEvent is not ES_Front_Bump_Detected
		Set ReturnEvent to ES_NO_EVENT
	EndIf
	
	Return ReturnEvent
}
End DuringReporting_2
