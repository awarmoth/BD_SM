module level variables: MyPriority, CurrentState, TeamColor, BallCount = 3, TargetStation, LastStation = 4, 
TargetGoal, Score, GameTimeoutFlag
ConstructingState_t: GettingTargetStation, DrivingAlongTape, Constructing, Shooting, Reloading
Module level functions: DuringGettingTargetStation, DuringDrivingAlongTape, DuringConstructing, DuringShooting, DuringReloading


void StartConstructingSM(ES_Event CurrentEvent)
{
	Set CurrentState to GettingTargetStation
	Run ConstructingSM with CurrentEvent
}
End StartConstructingSM


ES_Event RunConstructingSM(ES_Event CurrentEvent)
{
	local variable MakeTransition
	local variable NextState
	local variable EntryEvent
	local variable ReturnEvent
	local variable Event2Post
	
	Initialize MakeTransition to false
	Initialize NextState to CurrentState
	Initialize EntryEvent to ES_ENTRY
	Initialize ReturnEvent to CurrentEvent to assume no consumption of event
	
	If CurrentState is GettingTargetStation
	
		Run DuringGettingTargetStation and store the output in CurrentEvent
		
		If CurrentEvent is not ES_NO_EVENT
			If CurrentEvent is ES_LOC_COMPLETE
				Get response bytes from LOC
				Set SB1_byte to getSB1_Byte
				Set SB2_byte to getSB2_Byte
				Set SB3_byte to getSB3_Byte
				Update status variables
				Set MakeTransition to true
				Set NextState to DrivingAlongTape
				Set Event2Post type to ES_DRIVE_ALONG_TAPE
				Set Event2Post Param to TargetStation
				Post Event2Post to Master
			End ES_LOC_COMPLETE block
				
		Else
			Set ReturnEvent to ES_NO_EVENT
		EndIf
		
	End GettingTargetStation block
	
	If CurrentState is DrivingAlongTape
	
		Run DuringDrivingAlongTape and store the output in CurrentEvent
		
		If CurrentEvent is not ES_NO_EVENT
			If CurrentEvent is ES_ARRIVED_AT_STATION
				Set MakeTransition to true
					Transform ReturnEvent to ES_NO_EVENT
				Else If BadResponseCounter > MaxBadResponses
					Transform ReturnEvent to ES_Reorient
				Else
					Set Report Status to getReportStatus
					If ReportStatus = ACK
						Reset BadResponseCounter
						Set MakeTransition to true
						Set NextState to Constructing
					Else If ReportStatus = NACK
						Increment BadResponseCounter
						Set MakeTransition to true
						Set NextState to GettingTargetStation
					Else // report status = inactive
						Transform ReturnEvent to ES_Reorient
					EndIf
				EndIf
			EndIf
		
		Else
			Set ReturnEvent to ES_NO_EVENT
		EndIf
		
	End DrivingAlongTape block

	If CurrentState is Constructing
	
		Run DuringConstructing and store the output in CurrentEvent
		
		If CurrentEvent is not ES_NO_EVENT
			If CurrentEvent is ES_LOC_COMPLETE
				Set MakeTransition to true
				Set NextState to Shooting
			End ES_LOC_COMPLETE block
				
		Else
			Set ReturnEvent to ES_NO_EVENT
		EndIf
		
	End Constructing block
	
	If CurrentState is Shooting
	
		Run DuringShooting and store the output in CurrentEvent
		
		If CurrentEvent is not ES_NO_EVENT
			If CurrentEvent is ES_LOC_COMPLETE
				Set ResponseReady to getResponseReady
				If ResponseReady = not ready
					Set MakeTransition to true
					Transform ReturnEvent to ES_NO_EVENT
				Else If BadResponseCounter > MaxBadResponses
					Transform ReturnEvent to ES_Reorient
				Else
					Set ReportStatus to getReportStatus
					If ReportStatus = ACK
						Transform ReturnEvent to ES_Goal_Ready
						Set ReturnEvent paramater to getLocation //from Report Status byte
					Else If ReportStatus = NACK
						Increment BadResponseCounter
						Set MakeTransition to true
						Set NextState to Constructing
					Else // report status = inactive
						Transform ReturnEvent to ES_Reorient
					EndIf
				EndIf
			EndIf
		
		Else
			Set ReturnEvent to ES_NO_EVENT
		EndIf
		
	End Shooting block
	
	
	If MakeTransition is true
	
		Set CurrentEvent to ES_EXIT
		Run ConstructingSM with CurrentEvent to allow lower level SMs to exit
		
		Set CurrentState to NextState
		Run ConstructingSM with EntryEvent to allow lower level SMs to enter
		
	EndIf
	
	Return ReturnEvent
}
End RunConstructingSM


ES_Event DuringGettingTargetStation(ES_Event ThisEvent)
{
	local variable ReturnEvent
	
	Initialize ReturnEvent to ThisEvent
	
	If ThisEvent is ES_ENTRY or ES_ENTRY_HISTORY
		Frequency = getFrequency // ISR is constantly updating
		Set Byte2Write to report byte based on Frequency
		Post ES_Command to LOC w/ parameter: Byte2Write
	EndIf
	
	Return ReturnEvent
	
}
End DuringGettingTargetStation


ES_Event DuringDrivingAlongTape(ES_Event ThisEvent)
{
	local variable ReturnEvent
	
	Initialize ReturnEvent to ThisEvent
	
	If ThisEvent is ES_ENTRY or ES_ENTRY_HISTORY
		Set Byte2Write to report query response byte
		Post ES_Command to LOC w/ parameter: Byte2Write
	EndIf
	
	Return ReturnEvent
	
}
End DuringDrivingAlongTape


ES_Event DuringConstructing(ES_Event ThisEvent)
{
	local variable ReturnEvent
	
	Initialize ReturnEvent to ThisEvent
	
	If ThisEvent is ES_ENTRY or ES_ENTRY_HISTORY
		Frequency = getFrequency // ISR is constantly updating
		Set Byte2Write to report byte based on Frequency
		Post ES_Command to LOC w/ parameter: Byte2Write
	EndIf
	
	Return ReturnEvent
	
}
End DuringConstructing


ES_Event DuringShooting(ES_Event ThisEvent)
{
	local variable ReturnEvent
	
	Initialize ReturnEvent to ThisEvent
	
	If ThisEvent is ES_ENTRY or ES_ENTRY_HISTORY
		Set Byte2Write to report query response byte
		Post ES_Command to LOC w/ parameter: Byte2Write
	EndIf
	
	Return ReturnEvent
	
}
End DuringShooting

